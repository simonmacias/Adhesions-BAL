<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Adhérents</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        #map { height: 400px; }
    </style>
</head>
<body>
    <div id="app">
        <!-- Page de connexion -->
        <div v-if="!isAuthenticated" class="container mt-5">
            <div class="row justify-content-center">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="text-center">Connexion</h4>
                        </div>
                        <div class="card-body">
                            <div class="form-group mb-3">
                                <label for="password">Mot de passe</label>
                                <input 
                                    type="password" 
                                    class="form-control" 
                                    id="password"
                                    v-model="password"
                                    @keyup.enter="login"
                                >
                            </div>
                            <div v-if="authError" class="alert alert-danger">
                                Mot de passe incorrect
                            </div>
                            <button class="btn btn-primary w-100" @click="login">
                                Se connecter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenu principal -->
        <div v-else>
            <div id="app" class="container py-4" v-cloak>
                <div v-if="isAuthenticated">
                    <header class="bg-primary text-white py-3">
                        <div class="container">
                            <h1 class="h3">Gestion des Adhérents</h1>
                        </div>
                    </header>

                    <main class="container py-4">
                        <!-- Navigation par onglets -->
                        <ul class="nav nav-tabs mb-4">
                            <li class="nav-item">
                                <a class="nav-link" :class="{ active: activeTab === 'adherents' }" @click.prevent="activeTab = 'adherents'" href="#">
                                    <i class="bi bi-people"></i> Adhérents
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{ active: activeTab === 'stats' }" @click.prevent="activeTab = 'stats'" href="#">
                                    <i class="bi bi-graph-up"></i> Statistiques
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{ active: activeTab === 'benevoles' }" @click.prevent="activeTab = 'benevoles'" href="#">
                                    <i class="bi bi-heart"></i> Bénévoles
                                </a>
                            </li>
                            <li class="nav-item ms-auto">
                                <div class="dropdown">
                                    <button class="btn btn-outline-primary dropdown-toggle" type="button" id="importExportMenu" data-bs-toggle="dropdown">
                                        <i class="bi bi-gear"></i> Import/Export
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <a class="dropdown-item" href="#" @click="$refs.xlsFileInput.click()">
                                                <i class="bi bi-upload"></i> Importer XLS
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#" @click="$refs.jsonFileInput.click()">
                                                <i class="bi bi-code-slash"></i> Importer JSON
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#" @click="$refs.csvFileInput.click()">
                                                <i class="bi bi-file-text"></i> Importer CSV
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item" href="#" @click="startExport('xls')">
                                                <i class="bi bi-download"></i> Exporter XLS
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#" @click="startExport('json')">
                                                <i class="bi bi-code-slash"></i> Exporter JSON
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#" @click="startExport('csv')">
                                                <i class="bi bi-file-text"></i> Exporter CSV
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </li>
                        </ul>

                        <!-- Inputs cachés pour import -->
                        <input type="file" ref="xlsFileInput" accept=".xlsx,.xls" style="display: none;" @change="handleXLSImport">
                        <input type="file" ref="jsonFileInput" accept=".json" style="display: none;" @change="handleJSONImport">
                        <input type="file" ref="csvFileInput" accept=".csv" style="display: none;" @change="handleCSVImport">

                        <!-- Contenu de l'onglet Adhérents -->
                        <div v-if="activeTab === 'adherents'">
                            <!-- Barre de recherche -->
                            <div class="row mb-4">
                                <div class="col">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <div class="input-group">
                                                        <span class="input-group-text">
                                                            <i class="bi bi-search"></i>
                                                        </span>
                                                        <input 
                                                            type="text" 
                                                            class="form-control" 
                                                            v-model="searchQuery" 
                                                            placeholder="Rechercher un adhérent (nom, prénom, email, ville...)"
                                                        >
                                                        <button 
                                                            class="btn btn-outline-secondary" 
                                                            type="button"
                                                            @click="searchQuery = ''"
                                                            v-if="searchQuery"
                                                        >
                                                            <i class="bi bi-x-lg"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="btn-group">
                                                        <button 
                                                            class="btn" 
                                                            :class="activeFilter === 'tous' ? 'btn-primary' : 'btn-outline-primary'"
                                                            @click="activeFilter = 'tous'"
                                                        >
                                                            Tous
                                                        </button>
                                                        <button 
                                                            class="btn" 
                                                            :class="activeFilter === 'cotisation' ? 'btn-success' : 'btn-outline-success'"
                                                            @click="activeFilter = 'cotisation'"
                                                        >
                                                            Cotisation à jour
                                                        </button>
                                                        <button 
                                                            class="btn" 
                                                            :class="activeFilter === 'retard' ? 'btn-danger' : 'btn-outline-danger'"
                                                            @click="activeFilter = 'retard'"
                                                        >
                                                            En retard
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-2" v-if="filteredMembers.length !== members.length">
                                                <small class="text-muted">
                                                    {{ filteredMembers.length }} résultat(s) sur {{ members.length }} adhérents
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Bouton Nouvel adhérent -->
                            <div class="row mb-4">
                                <div class="col">
                                    <button @click="showAddModal" class="btn btn-primary">
                                        <i class="bi bi-plus-lg"></i> Nouvel adhérent
                                    </button>
                                </div>
                            </div>

                            <!-- Tableau des adhérents -->
                            <div class="row">
                                <div class="col">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Nom</th>
                                                    <th>Prénom</th>
                                                    <th>Email</th>
                                                    <th>Ville</th>
                                                    <th>Formule</th>
                                                    <th>Cotisation</th>
                                                    <th>Enfants</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="member in filteredMembers" :key="member.id">
                                                    <td>{{ member.nom }}</td>
                                                    <td>{{ member.prenom }}</td>
                                                    <td>{{ member.email }}</td>
                                                    <td>{{ member.ville }}</td>
                                                    <td>{{ member.formuleadhesion }}</td>
                                                    <td>
                                                        <span :class="member.cotisationAJour ? 'badge bg-success' : 'badge bg-danger'">
                                                            {{ member.cotisationAJour ? 'À jour' : 'En retard' }}
                                                        </span>
                                                    </td>
                                                    <td>{{ member.enfants || 0 }}</td>
                                                    <td>
                                                        <button @click="editMember(member)" class="btn btn-sm btn-outline-primary me-1">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button @click="deleteMember(member)" class="btn btn-sm btn-outline-danger">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Contenu de l'onglet Statistiques -->
                        <div v-if="activeTab === 'stats'" class="row">
                            <!-- Statistiques générales -->
                            <div class="col-12 mb-4">
                                <div class="row">
                                    <div class="col-md-3" v-for="stat in statistics" :key="stat.label">
                                        <div class="card">
                                            <div class="card-body">
                                                <h5 class="card-title">{{ stat.label }}</h5>
                                                <p class="card-text h3">{{ stat.value }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Graphiques -->
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">Répartition par formule d'adhésion</h5>
                                        <canvas ref="formulesChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">Répartition par genre</h5>
                                        <canvas ref="genreChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">Répartition par âge</h5>
                                        <canvas ref="agesChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">Évolution des cotisations</h5>
                                        <canvas ref="cotisationsChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Provenance des adhérents</h5>
                                        <div id="map"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Historique des adhésions</h5>
                                        <canvas ref="evolutionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modal pour ajout/modification -->
                        <div class="modal fade" id="memberModal" tabindex="-1" aria-labelledby="memberModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="memberModalLabel">
                                            {{ currentMember?.id ? 'Modifier' : 'Ajouter' }} un adhérent
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body" v-if="currentMember">
                                        <!-- Affichage des erreurs -->
                                        <div v-if="formErrors.length" class="alert alert-danger mb-3">
                                            <h6 class="alert-heading">Erreurs à corriger :</h6>
                                            <ul class="mb-0">
                                                <li v-for="error in formErrors" :key="error">{{ error }}</li>
                                            </ul>
                                        </div>

                                        <!-- Adhérents similaires -->
                                        <div v-if="similarMembers.length" class="alert alert-warning mb-3">
                                            <h6 class="alert-heading">Adhérents similaires trouvés :</h6>
                                            <ul class="mb-0">
                                                <li v-for="member in similarMembers" :key="member.id">
                                                    {{ member.nom }} {{ member.prenom }} ({{ member.email }})
                                                </li>
                                            </ul>
                                        </div>

                                        <div class="row g-3">
                                            <!-- Informations personnelles -->
                                            <div class="col-md-6">
                                                <label class="form-label">Nom *</label>
                                                <div class="position-relative">
                                                    <input type="text" 
                                                           class="form-control" 
                                                           :class="{ 'is-invalid': formErrors.includes('Le nom est obligatoire') }"
                                                           v-model="currentMember.nom"
                                                           @input="handleNomInput"
                                                           @blur="formatNomPrenom">
                                                    <div v-if="searchResults.length" 
                                                         class="position-absolute w-100 mt-1 bg-white border rounded shadow-sm" 
                                                         style="z-index: 1000; max-height: 200px; overflow-y: auto;">
                                                            <div v-for="result in searchResults" 
                                                                 :key="result.id"
                                                                 class="dropdown-item py-2 px-3 cursor-pointer"
                                                                 @click="selectMember(result)"
                                                                 style="cursor: pointer;">
                                                                <strong>{{ result.nom }} {{ result.prenom }}</strong>
                                                                <br>
                                                                <small class="text-muted">{{ result.email }}</small>
                                                            </div>
                                                        </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Prénom *</label>
                                                <input type="text" 
                                                       class="form-control"
                                                       :class="{ 'is-invalid': formErrors.includes('Le prénom est obligatoire') }"
                                                       v-model="currentMember.prenom"
                                                       @blur="formatNomPrenom">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Année de naissance</label>
                                                <input type="number" 
                                                       class="form-control" 
                                                       v-model.number="currentMember.datenaissance"
                                                       :min="1900" 
                                                       :max="currentYear"
                                                       placeholder="AAAA">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Genre</label>
                                                <select class="form-select" v-model="currentMember.genre">
                                                    <option value="">Sélectionner...</option>
                                                    <option value="F">Femme</option>
                                                    <option value="H">Homme</option>
                                                    <option value="A">Autre</option>
                                                </select>
                                            </div>

                                            <!-- Coordonnées -->
                                            <div class="col-md-12">
                                                <label class="form-label">Ville</label>
                                                <div class="position-relative">
                                                    <input 
                                                        type="text" 
                                                        class="form-control" 
                                                        v-model="villeSearch"
                                                        @input="searchVilles"
                                                        placeholder="Rechercher une ville..."
                                                    >
                                                    <div v-if="villeResults.length" class="position-absolute w-100 mt-1 bg-white border rounded shadow-sm" style="z-index: 1000; max-height: 200px; overflow-y: auto;">
                                                        <button 
                                                            v-for="result in villeResults" 
                                                            :key="result.code"
                                                            class="dropdown-item py-2 text-start w-100"
                                                            @click="selectVille(result)"
                                                        >
                                                            {{ result.nom }} ({{ result.code }})
                                                        </button>
                                                    </div>
                                                </div>
                                                <div v-if="currentMember.ville" class="mt-2">
                                                    <small class="text-muted">
                                                        {{ currentMember.ville }} - {{ currentMember.code_postal }}
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Email</label>
                                                <input type="email" class="form-control" v-model="currentMember.email">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Téléphone</label>
                                                <input type="tel" class="form-control" v-model="currentMember.telephone">
                                            </div>

                                            <!-- Informations d'adhésion -->
                                            <div class="col-md-6">
                                                <label class="form-label">Date d'adhésion</label>
                                                <input type="date" class="form-control" v-model="currentMember.dateadhesion">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Formule d'adhésion</label>
                                                <select class="form-select" v-model="currentMember.formuleadhesion" @change="updateMontantCotisation">
                                                    <option value="">Sélectionner...</option>
                                                    <option v-for="formule in formules" 
                                                            :key="formule.value" 
                                                            :value="formule.value">
                                                        {{ formule.label }}
                                                    </option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Montant cotisation (€)</label>
                                                <input type="number" class="form-control" v-model.number="currentMember.montantcotisation" min="0" step="0.5">
                                                <small class="form-text text-muted">Modifiable si besoin</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Nombre d'enfants</label>
                                                <input type="number" class="form-control" v-model.number="currentMember.enfants" min="0">
                                            </div>

                                            <!-- Historique -->
                                            <div class="col-12">
                                                <div class="card">
                                                    <div class="card-header d-flex justify-content-between align-items-center">
                                                        <h6 class="mb-0">Historique des adhésions</h6>
                                                        <button type="button" class="btn btn-outline-primary btn-sm" @click="ajouterAdhesion">
                                                            <i class="bi bi-plus-circle"></i> Nouvelle adhésion
                                                        </button>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="table-responsive">
                                                            <table class="table table-sm table-hover">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Date</th>
                                                                        <th>Formule</th>
                                                                        <th>Montant</th>
                                                                        <th class="text-end">Actions</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <tr v-for="(adhesion, index) in currentMember.historique" :key="index">
                                                                        <td>{{ formatDate(adhesion.date) }}</td>
                                                                        <td>{{ adhesion.formule }}</td>
                                                                        <td>{{ adhesion.montant }}€</td>
                                                                        <td class="text-end">
                                                                            <button type="button" 
                                                                                    class="btn btn-outline-danger btn-sm" 
                                                                                    @click="supprimerAdhesion(index)"
                                                                                    title="Supprimer cette adhésion">
                                                                                <i class="bi bi-trash"></i>
                                                                            </button>
                                                                        </td>
                                                                    </tr>
                                                                    <tr v-if="!currentMember.historique || currentMember.historique.length === 0">
                                                                        <td colspan="4" class="text-center text-muted">
                                                                            Aucune adhésion enregistrée
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                                <tfoot v-if="currentMember.historique && currentMember.historique.length > 0">
                                                                    <tr>
                                                                        <td colspan="2" class="text-end"><strong>Total :</strong></td>
                                                                        <td colspan="2">
                                                                            <strong>
                                                                                {{ currentMember.historique.reduce((sum, adh) => sum + adh.montant, 0) }}€
                                                                            </strong>
                                                                        </td>
                                                                    </tr>
                                                                </tfoot>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                        <button type="button" class="btn btn-primary" @click="saveMember">Enregistrer</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Contenu de l'onglet Bénévoles -->
                        <div v-if="activeTab === 'benevoles'" class="row">
                            <div class="col-12 mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Informations pour les bénévoles</h5>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-4">
                                                    <h6>Procédure d'adhésion</h6>
                                                    <ol class="list-group list-group-numbered">
                                                        <li class="list-group-item">Accueillir l'adhérent et présenter l'association</li>
                                                        <li class="list-group-item">Expliquer les différentes formules d'adhésion :
                                                            <ul class="mt-2">
                                                                <li>J'adhère (5€ ou plus) - Adhésion simple</li>
                                                                <li>J'adore (15€ ou plus) - Adhésion de soutien</li>
                                                                <li>J'accélère (20€ ou plus) - Super adhérent</li>
                                                                <li>Passage (Prix Libre) - Adhésion ponctuelle</li>
                                                            </ul>
                                                        </li>
                                                        <li class="list-group-item">Remplir le formulaire avec les informations de l'adhérent</li>
                                                        <li class="list-group-item">Encaisser la cotisation et noter le montant</li>
                                                        <li class="list-group-item">Remettre le reçu d'adhésion</li>
                                                    </ol>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-4">
                                                    <h6>Contacts utiles</h6>
                                                    <div class="list-group">
                                                        <div class="list-group-item">
                                                            <h6 class="mb-1">Présidents de l'association</h6>
                                                            <p class="mb-1">Agathe MARTIN & Sylvain MILLET</p>
                                                            <small>06.00.00.00.00 - 06.10.11.12.13</small>
                                                        </div>
                                                        <div class="list-group-item">
                                                            <h6 class="mb-1">Support technique</h6>
                                                            <p class="mb-1">Simon MACIAS</p>
                                                            <small>06.16.40.23.36 - simon.macias@riseup.net</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modal pour sélection de période -->
                        <div class="modal fade" id="periodModal" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Sélection de la période</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Date de début</label>
                                                <input type="date" class="form-control" v-model="exportPeriod.start">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Date de fin</label>
                                                <input type="date" class="form-control" v-model="exportPeriod.end">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                        <button type="button" class="btn btn-primary" @click="confirmExport">Exporter</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    isAuthenticated: false,
                    password: '',
                    authError: false,
                    members: [],
                    currentMember: null,
                    searchQuery: '',
                    activeFilter: 'tous',
                    activeTab: 'adherents',
                    statistics: [],
                    formErrors: [],
                    similarMembers: [],
                    searchResults: [],
                    villeSearch: '',
                    villeResults: [],
                    formules: [
                        { value: "J'adhère", label: "J'adhère (5€ ou plus)" },
                        { value: "J'adore", label: "J'adore (15€ ou plus)" },
                        { value: "J'accélère", label: "J'accélère (20€ ou plus)" },
                        { value: "Passage", label: "Passage (Prix libre)" }
                    ],
                    exportPeriod: {
                        start: '',
                        end: ''
                    }
                }
            },
            computed: {
                filteredMembers() {
                    if (!this.members) return [];
                    
                    let result = this.members;
                    
                    // Filtre de recherche
                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase();
                        result = result.filter(member => 
                            member.nom?.toLowerCase().includes(query) ||
                            member.prenom?.toLowerCase().includes(query) ||
                            member.email?.toLowerCase().includes(query) ||
                            member.ville?.toLowerCase().includes(query)
                        );
                    }
                    
                    // Filtre de cotisation
                    if (this.activeFilter === 'cotisation') {
                        result = result.filter(member => member.cotisationAJour);
                    } else if (this.activeFilter === 'retard') {
                        result = result.filter(member => !member.cotisationAJour);
                    }
                    
                    return result;
                }
            },
            methods: {
                login() {
                    if (this.password === 'BAL2025') {
                        this.isAuthenticated = true;
                        this.authError = false;
                        sessionStorage.setItem('isAuthenticated', 'true');
                        this.loadData();
                    } else {
                        this.authError = true;
                    }
                },
                async loadData() {
                    try {
                        // Pour le moment, on charge les données depuis un fichier JSON statique
                        const response = await fetch('adherents_2025_complet.json');
                        const data = await response.json();
                        this.members = data.members || [];
                        this.updateStatistics();
                    } catch (error) {
                        console.error('Erreur lors du chargement des données:', error);
                    }
                },
                updateStatistics() {
                    // Mise à jour des statistiques de base
                    this.statistics = [
                        { label: 'Total Adhérents', value: this.members.length },
                        { label: 'Cotisations à jour', value: this.members.filter(m => m.cotisationAJour).length },
                        { label: 'Nouveaux (2024)', value: this.members.filter(m => m.dateadhesion?.includes('2024')).length },
                        { label: 'Montant total', value: this.members.reduce((sum, m) => sum + (m.montantcotisation || 0), 0) + '€' }
                    ];
                }
            },
            mounted() {
                this.isAuthenticated = sessionStorage.getItem('isAuthenticated') === 'true';
                if (this.isAuthenticated) {
                    this.loadData();
                }
            }
        }).mount('#app')
    </script>
</body>
</html>